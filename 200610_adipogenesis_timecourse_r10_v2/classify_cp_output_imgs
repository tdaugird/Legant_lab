{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "This is code that will read in cp output images, classify them using a random tree classifier and save the parsed image.\n",
    "\n",
    "This is also code that does a quick test of whether or not it is useful to use dask for this kind of thing. Becaus I think that most of my computation time is actually taking reading and writing files I do not get much of a speed up with this"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Imports"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "from scipy import ndimage as ndi\n",
    "import numpy as np\n",
    "import matplotlib.pyplot as plt\n",
    "from skimage import io\n",
    "import pandas as pd\n",
    "from scipy import ndimage\n",
    "from skimage import measure\n",
    "from sklearn.ensemble import RandomForestClassifier\n",
    "from sklearn.preprocessing import StandardScaler"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# set up directories"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "orig_img_dir = r'Y:\\TAD\\200610_adipogenesis_timecourse_r10_v2\\gr-rxr-set\\mid_slices' #directory of the mid slices .tif files\n",
    "segm_img_dir = r'Y:\\TAD\\200610_adipogenesis_timecourse_r10_v2\\gr-rxr-set\\mid_slice_nucl_segm' #directory of the segmented .tif files\n",
    "annotated_csv_dir = r'C:\\Users\\LegantLab\\Documents\\git\\tad\\adipogenesis_timcecourses_revisited\\200610_adipogenesis_timecourse_r10_v2\\annotation_csvs' #directory of the annotated .csv files\n",
    "filtered_segm_img_dir = r'Y:\\TAD\\200610_adipogenesis_timecourse_r10_v2\\gr-rxr-set\\mid_slice_segm_filtered' #directory of the paresed segmented imags\n",
    "#ase_img_name = 'stad3-29-xy1c1'"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Train classifier"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "RandomForestClassifier(bootstrap=True, ccp_alpha=0.0, class_weight=None,\n",
       "                       criterion='gini', max_depth=None, max_features='auto',\n",
       "                       max_leaf_nodes=None, max_samples=None,\n",
       "                       min_impurity_decrease=0.0, min_impurity_split=None,\n",
       "                       min_samples_leaf=1, min_samples_split=2,\n",
       "                       min_weight_fraction_leaf=0.0, n_estimators=100,\n",
       "                       n_jobs=None, oob_score=False, random_state=None,\n",
       "                       verbose=0, warm_start=False)"
      ]
     },
     "execution_count": 3,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "'''Train the classifier'''\n",
    "\n",
    "os.chdir(annotated_csv_dir)\n",
    "df_train_orig = pd.read_csv('annotated_df_orig.csv')\n",
    "\n",
    "\n",
    "keep_cats = [ 'area',\n",
    " 'bbox_area',\n",
    " 'centroid-0',\n",
    " 'centroid-1',\n",
    " 'convex_area',\n",
    " 'eccentricity',\n",
    " 'equivalent_diameter',\n",
    " 'extent',\n",
    " 'local_centroid-0',\n",
    " 'local_centroid-1',\n",
    " 'major_axis_length',\n",
    " 'minor_axis_length',\n",
    " 'perimeter',\n",
    " 'solidity',\n",
    " 'inertia_tensor_eigvals-0',\n",
    " 'inertia_tensor_eigvals-1',\n",
    " 'moments_hu-0',\n",
    " 'moments_hu-1',\n",
    " 'moments_hu-2',\n",
    " 'moments_hu-3',\n",
    " 'moments_hu-4',\n",
    " 'moments_hu-5',\n",
    " 'moments_hu-6',\n",
    " 'in_object']\n",
    "\n",
    "\n",
    "df_train = df_train_orig[keep_cats] # make a copy of original df. I am going to alter this a little bit in order to pull out train and test cats\n",
    "df_train = df_train.dropna()\n",
    "\n",
    "'''this is target category for the training the classifier'''\n",
    "target_cat_name = 'in_object'\n",
    "\n",
    "'''define train and target data'''\n",
    "x_train = df_train.drop('in_object', axis = 1)\n",
    "y_train = df_train[target_cat_name]\n",
    "\n",
    "'''this is a feature scaling step. This will standardize all of the data in order to pull everything into the same range'''\n",
    "sc_X = StandardScaler()\n",
    "x_train = sc_X.fit_transform(x_train)\n",
    "\n",
    "'''random forest classifier'''\n",
    "clf=RandomForestClassifier(n_estimators=100)\n",
    "\n",
    "clf.fit(x_train,y_train)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Try the original code without using dask"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## generate a list of all of the segmented image files"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [],
   "source": [
    "'''make list of segmented images over which to iterate'''\n",
    "os.chdir(segm_img_dir)\n",
    "\n",
    "img_lst = []\n",
    "\n",
    "for i in os.listdir():\n",
    "    if '.tif' in i:\n",
    "        img_lst.append(i)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# test the original code without dask"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad424_rois002_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad424_rois002_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad424_rois002_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad424_rois002_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad424_rois002_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad424_rois002_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad424_rois002_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad424_rois002_fov7_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad424_rois002_fov8_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad424_rois002_fov9_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois001_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois001_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois001_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois001_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois001_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois004_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois004_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois004_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois004_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois004_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois005_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois005_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois005_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois005_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad425_rois005_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois001_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois001_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois001_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois001_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois001_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois001_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois001_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois002_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois002_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois002_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois002_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois002_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois002_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois002_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad426_rois002_fov7_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois001_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois001_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois001_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois001_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois001_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois001_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois001_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois002_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois002_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois002_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois002_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois002_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois002_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois002_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad427_rois002_fov7_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois001_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois001_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois001_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois001_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois001_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois001_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois001_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois002_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois002_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois002_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois002_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois002_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois002_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois002_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad428_rois002_fov7_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois001_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois001_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois001_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois001_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois001_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois001_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois001_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois002_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois002_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois002_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois002_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois002_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois002_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois002_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad430_rois002_fov7_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois001_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois001_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois001_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois001_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois001_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois002_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois002_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois002_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois002_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois002_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois002_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois002_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois002_fov7_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois002_fov8_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad431_rois002_fov9_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov10_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov11_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov12_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov13_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov14_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov7_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov8_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad432_rois001_fov9_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov10_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov11_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov12_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov13_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov14_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov7_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov8_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois001_fov9_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov10_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov11_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov12_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov13_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov14_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov7_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov8_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad433_rois002_fov9_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov10_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov11_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov12_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov13_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov14_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov7_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov8_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad434_rois001_fov9_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov0_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov10_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov11_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov12_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov13_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov14_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov1_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov2_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov3_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov4_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov5_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov6_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov7_c4_sesegm_parsed.tiff is a low contrast image\n",
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov8_c4_sesegm_parsed.tiff is a low contrast image\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Wall time: 2min 22s\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\LegantLab\\anaconda3\\lib\\site-packages\\ipykernel_launcher.py:31: UserWarning: stad435_rois001_fov9_c4_sesegm_parsed.tiff is a low contrast image\n"
     ]
    }
   ],
   "source": [
    "%%time\n",
    "'''iterate over images, apply classifier and generate new image'''\n",
    "\n",
    "#img_lst = img_lst[:15]\n",
    "\n",
    "for segm_img_filename in img_lst:\n",
    "    segm_img_orig = io.imread(segm_img_filename) #read in original image\n",
    "    ###################### double check this as think may be wrong ##################################\n",
    "    #segm_img_orig = np.sum(segm_img_orig, axis = 2) #shift rbg into one channel.\n",
    "    #######################################################################\n",
    "    #labeled_img_orig = measure.label(segm_img_orig) #label the objects within the image \n",
    "    '''make a dataframe of object parameters'''\n",
    "    df_test_orig = pd.DataFrame(measure.regionprops_table(segm_img_orig, properties = ('label',  'area',  'bbox_area', 'centroid', 'convex_area', \n",
    "                                                       'eccentricity', 'equivalent_diameter',\n",
    "                                                       'extent', 'local_centroid', 'major_axis_length', \n",
    "                                                                   'minor_axis_length', 'perimeter', 'solidity', 'inertia_tensor_eigvals',\n",
    "                                                                            'moments_hu',)))\n",
    "    '''generate a new data frame that contains only the predicted in objects'''\n",
    "    df_test = df_test_orig[keep_cats[:-1]] #this pulls out categories for predicting\n",
    "    x_test = sc_X.transform(df_test) #normalize all of the parameters \n",
    "    #df_test['in_object'] = clf.predict(x_test)\n",
    "    df_test_orig['in_object'] = clf.predict(x_test) #add the prediction to the original df\n",
    "    df_parsed = df_test_orig.loc[df_test_orig.in_object == 1] # make a dataframe that includes only the in objects\n",
    "    \n",
    "    '''generate and save image parsed image'''\n",
    "    kept_labeled_objects = np.array(df_parsed.label) #make list of objects to keep\n",
    "    kept_img_bool = np.isin(segm_img_orig, kept_labeled_objects) #make a boolean image of things to keep\n",
    "    labeled_img_parsed = np.multiply(kept_img_bool, segm_img_orig) #this is the labeled image\n",
    "    labeled_img_parsed = labeled_img_parsed.astype('uint16') #change the labeled image over to 16bit to be compatable with the other images\n",
    "    '''save parsed image'''\n",
    "    os.chdir(filtered_segm_img_dir)\n",
    "    io.imsave(segm_img_filename[:-7] + 'segm_parsed.tiff', labeled_img_parsed)\n",
    "    \n",
    "    os.chdir(segm_img_dir)\n",
    "    \n",
    "    \n",
    "    "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Test the code with dask"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "application/vnd.jupyter.widget-view+json": {
       "model_id": "6682eda9da194b5a9ec86e7873b7c10b",
       "version_major": 2,
       "version_minor": 0
      },
      "text/plain": [
       "VBox(children=(HTML(value='<h2>LocalCluster</h2>'), HBox(children=(HTML(value='\\n<div>\\n  <style scoped>\\n    …"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "from dask.distributed import Client\n",
    "\n",
    "client = Client()\n",
    "client.cluster"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "metadata": {},
   "outputs": [],
   "source": [
    "from dask import delayed\n",
    "import dask"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## set up the filter_img function to be delayed"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {},
   "outputs": [],
   "source": [
    "def filter_img(img_):\n",
    "    \n",
    "    \n",
    "    segm_img_orig = io.imread(img_) #read in original image\n",
    "    #segm_img_orig = segm_img_orig_\n",
    "    df_test_orig = pd.DataFrame(measure.regionprops_table(segm_img_orig, properties = ('label',  'area',  'bbox_area', 'centroid', 'convex_area', \n",
    "                                                       'eccentricity', 'equivalent_diameter',\n",
    "                                                       'extent', 'local_centroid', 'major_axis_length', \n",
    "                                                                   'minor_axis_length', 'perimeter', 'solidity', 'inertia_tensor_eigvals',\n",
    "                                                                            'moments_hu',)))\n",
    "    '''generate a new data frame that contains only the predicted in objects'''\n",
    "    df_test = df_test_orig[keep_cats[:-1]] #this pulls out categories for predicting\n",
    "    x_test = sc_X.transform(df_test) #normalize all of the parameters \n",
    "    #df_test['in_object'] = clf.predict(x_test)\n",
    "    df_test_orig['in_object'] = clf.predict(x_test) #add the prediction to the original df\n",
    "    df_parsed = df_test_orig.loc[df_test_orig.in_object == 1] # make a dataframe that includes only the in objects\n",
    "    \n",
    "    '''generate and save image parsed image'''\n",
    "    kept_labeled_objects = np.array(df_parsed.label) #make list of objects to keep\n",
    "    kept_img_bool = np.isin(segm_img_orig, kept_labeled_objects) #make a boolean image of things to keep\n",
    "    labeled_img_parsed = np.multiply(kept_img_bool, segm_img_orig) #this is the labeled image\n",
    "    labeled_img_parsed = labeled_img_parsed.astype('uint16') #change the labeled image over to 16bit to be compatable with the other images\n",
    "    '''save parsed image'''\n",
    "    os.chdir(filtered_segm_img_dir)\n",
    "    io.imsave(filename_[:-7] + 'segm_parsed.tiff', labeled_img_parsed)\n",
    "    os.chdir(segm_img_dir)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {},
   "outputs": [],
   "source": [
    "'''make list of segmented images over which to iterate'''\n",
    "os.chdir(segm_img_dir)\n",
    "\n",
    "img_lst = []\n",
    "\n",
    "for i in os.listdir():\n",
    "    if '.tif' in i:\n",
    "        img_lst.append(i)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Wall time: 999 µs\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "()"
      ]
     },
     "execution_count": 22,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "%%time\n",
    "'''iterate over images, apply classifier and generate new image'''\n",
    "\n",
    "#img_lst = img_lst[15:31]\n",
    "img_lst =[]\n",
    "for filename_ in img_lst:\n",
    "#    img = io.imread(filename_) #read in original image\n",
    "    ###################### double check this as think may be wrong ##################################\n",
    "    #segm_img_orig = np.sum(segm_img_orig, axis = 2) #shift rbg into one channel.\n",
    "    #######################################################################\n",
    "    #labeled_img_orig = measure.label(segm_img_orig) #label the objects within the image \n",
    "    img = delayed(io.imread(filename_)) #read in original image\n",
    "    #segm_img_orig = segm_img_orig_\n",
    "    delayed(filter_img)(img)\n",
    "dask.compute()\n",
    "    \n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "metadata": {},
   "outputs": [
    {
     "ename": "NameError",
     "evalue": "name 'out' is not defined",
     "output_type": "error",
     "traceback": [
      "\u001b[1;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[1;31mNameError\u001b[0m                                 Traceback (most recent call last)",
      "\u001b[1;32m<ipython-input-21-0c414b0cb4b4>\u001b[0m in \u001b[0;36m<module>\u001b[1;34m\u001b[0m\n\u001b[1;32m----> 1\u001b[1;33m \u001b[0mout\u001b[0m\u001b[1;33m.\u001b[0m\u001b[0mshape\u001b[0m\u001b[1;33m\u001b[0m\u001b[1;33m\u001b[0m\u001b[0m\n\u001b[0m",
      "\u001b[1;31mNameError\u001b[0m: name 'out' is not defined"
     ]
    }
   ],
   "source": [
    "out.shape"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "img_analysis",
   "language": "python",
   "name": "img_analysis"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.6"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
